# AI Code Review - GitHub Actions
# OpenAI API „ÇíÁõ¥Êé•‰ΩøÁî®„Åó„Åü„Ç≥„Éº„Éâ„É¨„Éì„É•„Éº

name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- . ':!*.md' ':!*.json' ':!*.lock' ':!node_modules/*' ':!dist/*' ':!*.min.js' | head -c 50000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Code Review
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          DIFF='${{ steps.diff.outputs.diff }}'

          if [ -z "$DIFF" ]; then
            echo "review=„É¨„Éì„É•„ÉºÂØæË±°„ÅÆ„Ç≥„Éº„ÉâÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì ‚úÖ" >> $GITHUB_OUTPUT
            exit 0
          fi

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @- << EOF
          {
            "model": "gpt-5.2",
            "messages": [
              {
                "role": "system",
                "content": "„ÅÇ„Å™„Åü„ÅØ„Ç≥„Éº„Éâ„É¨„Éì„É•„Ç¢„Éº„Åß„Åô„ÄÇ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Å®ÈáçÂ§ß„Å™„É≠„Ç∏„ÉÉ„ÇØ„Ç®„É©„Éº„ÅÆ„Åø„Å´ÁÑ¶ÁÇπ„ÇíÂΩì„Å¶„Å¶„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\nÂÑ™ÂÖàÂ∫¶:\n- P0: „Çª„Ç≠„É•„É™„ÉÜ„Ç£ËÑÜÂº±ÊÄß„ÄÅË™çË®º„Éê„Ç§„Éë„Çπ„ÄÅ„Éá„Éº„ÇøÊºèÊ¥©\n- P1: „É≠„Ç∏„ÉÉ„ÇØ„Ç®„É©„Éº„ÄÅ„É¨„Éº„Çπ„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥„ÄÅnull„Éù„Ç§„É≥„Çø\n- P2: „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂïèÈ°å\n\n„É´„Éº„É´:\n- Êó•Êú¨Ë™û„Åß„Ç≥„É°„É≥„Éà\n- „Çπ„Çø„Ç§„É´„ÇÑ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅØÁÑ°Ë¶ñÔºàCodeRabbit„ÅåÊãÖÂΩìÔºâ\n- ÂïèÈ°å„Åå„Å™„Åë„Çå„Å∞„ÄåÂïèÈ°å„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü ‚úÖ„Äç„Å®ÂõûÁ≠î\n\nÂá∫ÂäõÂΩ¢Âºè:\n**[P0/P1/P2]** ÂïèÈ°å„ÅÆË™¨Êòé\n- üìç „Éï„Ç°„Ç§„É´:Ë°åÁï™Âè∑\n- üí° ÁêÜÁî±\n- üîß ‰øÆÊ≠£Ê°à"
              },
              {
                "role": "user",
                "content": "‰ª•‰∏ã„ÅÆdiff„Çí„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\n\n$DIFF"
              }
            ],
            "max_tokens": 2000
          }
          EOF
          )

          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "„É¨„Éì„É•„ÉºÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"')

          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const review = `${{ steps.review.outputs.review }}`;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const aiComment = comments.data.find(c =>
              c.body.includes('<!-- ai-code-review -->')
            );

            const body = `<!-- ai-code-review -->
## ü§ñ AI Code Review

${review}

---
*Powered by OpenAI GPT-4o*`;

            if (aiComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: aiComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
