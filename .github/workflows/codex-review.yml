# AI Code Review - GitHub Actions
# OpenAI API ã‚’ç›´æ¥ä½¿ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼

name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- . ':!*.md' ':!*.json' ':!*.lock' ':!node_modules/*' ':!dist/*' ':!*.min.js' | head -c 50000)
          {
            echo 'content<<EOF'
            echo "$DIFF"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: AI Code Review
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF_CONTENT: ${{ steps.diff.outputs.content }}
        run: |
          if [ -z "$DIFF_CONTENT" ]; then
            echo "result=ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ âœ…" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Build JSON payload using jq (handles all escaping correctly)
          PAYLOAD=$(jq -n \
            --arg diff "$DIFF_CONTENT" \
            '{
              "model": "gpt-4o",
              "messages": [
                {
                  "role": "system",
                  "content": "ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨é‡å¤§ãªãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ã®ã¿ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚\n\nå„ªå…ˆåº¦:\n- P0: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã€èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ã€ãƒ‡ãƒ¼ã‚¿æ¼æ´©\n- P1: ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ã€ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã€nullãƒã‚¤ãƒ³ã‚¿\n- P2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ\n\nãƒ«ãƒ¼ãƒ«:\n- æ—¥æœ¬èªã§ã‚³ãƒ¡ãƒ³ãƒˆ\n- ã‚¹ã‚¿ã‚¤ãƒ«ã‚„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ç„¡è¦–ï¼ˆCodeRabbitãŒæ‹…å½“ï¼‰\n- å•é¡ŒãŒãªã‘ã‚Œã°ã€Œå•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ âœ…ã€ã¨å›ç­”\n\nå‡ºåŠ›å½¢å¼:\n**[P0/P1/P2]** å•é¡Œã®èª¬æ˜\n- ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«:è¡Œç•ªå·\n- ğŸ’¡ ç†ç”±\n- ğŸ”§ ä¿®æ­£æ¡ˆ"
                },
                {
                  "role": "user",
                  "content": $diff
                }
              ],
              "max_tokens": 2000
            }')

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD")

          # Debug: check for API errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown API error"')
            echo "API Error: $ERROR_MSG" >&2
            REVIEW="âš ï¸ API ã‚¨ãƒ©ãƒ¼: $ERROR_MSG"
          else
            REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"')
          fi

          {
            echo 'result<<EOF'
            echo "$REVIEW"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Post review comment
        uses: actions/github-script@v7
        env:
          REVIEW_RESULT: ${{ steps.review.outputs.result }}
        with:
          script: |
            const review = process.env.REVIEW_RESULT || 'ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒã‚ã‚Šã¾ã›ã‚“';

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const aiComment = comments.data.find(c =>
              c.body.includes('<!-- ai-code-review -->')
            );

            const body = `<!-- ai-code-review -->
## ğŸ¤– AI Code Review

${review}

---
*Powered by OpenAI GPT-4o*`;

            if (aiComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: aiComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
