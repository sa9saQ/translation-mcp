# Codex Code Review - OpenAI GPT-5.2-Codex
# OpenAI Responses API „Çí‰ΩøÁî®„Åó„Åü„Ç≥„Éº„Éâ„É¨„Éì„É•„Éº
#
# ‰Ωø„ÅÑÊñπ:
# 1. „Åì„ÅÆ„Éï„Ç°„Ç§„É´„Çí .github/workflows/codex-review.yml „Å´„Ç≥„Éî„Éº
# 2. „É™„Éù„Ç∏„Éà„É™„ÅÆSecrets „Å´ OPENAI_API_KEY „ÇíË®≠ÂÆö
#
# „É¢„Éá„É´: gpt-5.2-codex (ÊúÄÊñ∞„Ç≥„Éº„Éá„Ç£„É≥„Ç∞ÁâπÂåñ„É¢„Éá„É´)
# API: Responses API (/v1/responses)

name: Codex Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  codex-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Get PR diff
        id: diff
        run: |
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- . \
            ':!*.md' ':!*.json' ':!*.lock' ':!node_modules/*' ':!dist/*' ':!*.min.js' \
            | head -c 50000)

          if [ -z "$DIFF" ]; then
            echo "content=" >> "$GITHUB_OUTPUT"
            echo "has_diff=false" >> "$GITHUB_OUTPUT"
          else
            # Base64 encode to preserve special characters
            ENCODED=$(echo "$DIFF" | base64 -w 0)
            echo "content=$ENCODED" >> "$GITHUB_OUTPUT"
            echo "has_diff=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Codex Review
        id: review
        if: steps.diff.outputs.has_diff == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF_ENCODED: ${{ steps.diff.outputs.content }}
        run: |
          # Check if API key is set
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "result=‚ö†Ô∏è OPENAI_API_KEY „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„É™„Éù„Ç∏„Éà„É™„ÅÆSecrets„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Decode diff
          DIFF_CONTENT=$(echo "$DIFF_ENCODED" | base64 -d)

          # Build JSON payload for Responses API
          PAYLOAD=$(jq -n \
            --arg diff "$DIFF_CONTENT" \
            '{
              "model": "gpt-5.2-codex",
              "instructions": "„ÅÇ„Å™„Åü„ÅØ„Ç≥„Éº„Éâ„É¨„Éì„É•„Ç¢„Éº„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆË¶≥ÁÇπ„Åß„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n\n## „É¨„Éì„É•„ÉºË¶≥ÁÇπ\n1. **„Éê„Ç∞„ÉªË´ñÁêÜ„Ç®„É©„Éº** - ÊΩúÂú®ÁöÑ„Å™„Éê„Ç∞„ÄÅ„Ç®„ÉÉ„Ç∏„Ç±„Éº„Çπ„ÄÅÁ´∂ÂêàÁä∂ÊÖã\n2. **„Çª„Ç≠„É•„É™„ÉÜ„Ç£** - OWASP Top 10„ÄÅ„Ç§„É≥„Ç∏„Çß„ÇØ„Ç∑„Éß„É≥„ÄÅË™çË®º/Ë™çÂèØ„ÅÆÂïèÈ°å\n3. **„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ** - N+1„ÇØ„Ç®„É™„ÄÅ‰∏çË¶Å„Å™„É´„Éº„Éó„ÄÅ„É°„É¢„É™„É™„Éº„ÇØ\n4. **‰øùÂÆàÊÄß** - DRYÈÅïÂèç„ÄÅË§áÈõë„Åô„Åé„Çã„É≠„Ç∏„ÉÉ„ÇØ\n\n## „É´„Éº„É´\n- Êó•Êú¨Ë™û„Åß„Ç≥„É°„É≥„Éà\n- ÈáçË¶Å„Å™ÂïèÈ°å„ÅÆ„ÅøÊåáÊëòÔºàËªΩÂæÆ„Å™ÂïèÈ°å„ÅØÁúÅÁï•Ôºâ\n- „Çπ„Çø„Ç§„É´„ÇÑ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅØÁÑ°Ë¶ñ\n\n## Âá∫ÂäõÂΩ¢Âºè\n```\n## üî¥ Critical (‰øÆÊ≠£ÂøÖÈ†à)\n- [ÂïèÈ°å] („Éï„Ç°„Ç§„É´:Ë°åÁï™Âè∑)\n\n## üü° Warning (Êé®Â•®‰øÆÊ≠£)\n- [ÂïèÈ°å] („Éï„Ç°„Ç§„É´:Ë°åÁï™Âè∑)\n\n## ‚úÖ Á∑èÂêàË©ï‰æ°\nÊâøË™ç / Ë¶Å‰øÆÊ≠£ / „Éñ„É≠„ÉÉ„ÇØ\n```\n\nÂïèÈ°å„Åå„Å™„Åë„Çå„Å∞„ÄåÂïèÈ°å„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü ‚úÖ„Äç„Å®ÂõûÁ≠î",
              "input": ("‰ª•‰∏ã„ÅÆ„Ç≥„Éº„ÉâÂ∑ÆÂàÜ„Çí„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n\n" + $diff),
              "reasoning": {"effort": "medium"},
              "max_output_tokens": 2000
            }')

          # Call OpenAI Responses API
          RESPONSE=$(curl -s -w "\n%{http_code}" https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD")

          # Extract HTTP status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          # Handle errors
          if [ "$HTTP_CODE" != "200" ]; then
            ERROR_MSG=$(echo "$BODY" | jq -r '.error.message // "Unknown API error"')
            echo "result=‚ö†Ô∏è API „Ç®„É©„Éº ($HTTP_CODE): $ERROR_MSG" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Extract review content from Responses API format
          REVIEW=$(echo "$BODY" | jq -r '
            .output_text //
            .output[0].content[0].text //
            (.output[] | select(.type == "message") | .content[0].text) //
            empty
          ' 2>/dev/null)

          # Fallback: recursive text extraction
          if [ -z "$REVIEW" ]; then
            REVIEW=$(echo "$BODY" | jq -r '.. | objects | select(has("text")) | .text' 2>/dev/null | head -1)
          fi

          if [ -z "$REVIEW" ]; then
            REVIEW="„É¨„Éì„É•„ÉºÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
          fi

          # Save to file to preserve formatting
          echo "$REVIEW" > /tmp/review_result.txt

          {
            echo 'result<<REVIEW_EOF'
            cat /tmp/review_result.txt
            echo 'REVIEW_EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Skip if no diff
        id: skip
        if: steps.diff.outputs.has_diff != 'true'
        run: |
          echo "result=„É¨„Éì„É•„ÉºÂØæË±°„ÅÆ„Ç≥„Éº„ÉâÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì ‚úÖ" >> "$GITHUB_OUTPUT"

      - name: Post review comment
        uses: actions/github-script@v7
        env:
          REVIEW_RESULT: ${{ steps.review.outputs.result || steps.skip.outputs.result }}
        with:
          script: |
            const review = process.env.REVIEW_RESULT || '„É¨„Éì„É•„ÉºÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
            const now = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            const body = [
              '## ü§ñ Codex Code Review (GPT-5.2-Codex)',
              `üìÖ ${now}`,
              '',
              review,
              '',
              '---',
              '*Powered by OpenAI GPT-5.2-Codex via Responses API*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });
