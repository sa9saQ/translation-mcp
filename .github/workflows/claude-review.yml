# Claude Code GitHub Action Template
# PRの自動レビュー、Issue対応、セキュリティ監査（安定版）

name: Claude Code Automation

on:
  # PRへのコメント（@claude mentionで発火）
  issue_comment:
    types: [created]

  # PR作成/更新時
  pull_request:
    types: [opened, synchronize, reopened]

  # Issue割り当て時
  issues:
    types: [assigned]

  # 手動トリガー
  workflow_dispatch:
    inputs:
      task:
        description: 'Task for Claude to perform'
        required: true
        type: string

# 権限設定
permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  # @claude mention対応
  respond-to-mention:
    if: >
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude Code Response
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # PRレビュー（シンプル版 - 安定性重視）
  pr-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this PR focusing on:
            1. Security issues (hardcoded secrets, injection, auth bypass)
            2. Bugs (null refs, race conditions, logic errors)
            3. Critical code quality issues

            Output format:
            ## Summary
            [1-2 sentence summary]

            ## Issues Found
            | Severity | File | Issue | Fix |
            |----------|------|-------|-----|

            ## Recommendation
            ✅ APPROVE / ⚠️ REQUEST CHANGES / ❌ BLOCK

  # Issue自動実装
  auto-implement:
    if: >
      github.event_name == 'issues' &&
      github.event.action == 'assigned' &&
      github.event.assignee.login == 'claude-code[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Implementation
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Implement the feature/fix described in this issue.
            1. Read existing code patterns
            2. Implement with proper error handling
            3. Create a PR with description

  # 手動タスク実行
  manual-task:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Task
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Task: ${{ github.event.inputs.task }}
            Execute the requested task.
