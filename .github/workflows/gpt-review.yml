# GPT 5.2 Code Review GitHub Action Template
# OpenAI API ã‚’ä½¿ç”¨ã—ãŸåŒ…æ‹¬çš„ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰

name: GPT Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      review_focus:
        description: 'Review focus area'
        required: false
        type: choice
        options:
          - full
          - security
          - maintainability
          - performance
        default: full

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  MAX_DIFF_SIZE: 100000
  OPENAI_MODEL: gpt-5.2

jobs:
  comprehensive-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff and metadata
        id: pr_data
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

          # Get diff excluding non-code files
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD \
            -- . ':!*.md' ':!*.json' ':!*.lock' ':!*.yaml' ':!*.yml' \
            ':!node_modules/*' ':!dist/*' ':!build/*' ':!*.min.js' ':!*.min.css' \
            ':!package-lock.json' ':!pnpm-lock.yaml' ':!yarn.lock' \
            | head -c ${{ env.MAX_DIFF_SIZE }})

          # Get changed files list
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | head -50)

          # Get stats
          STATS=$(git diff --stat origin/${{ github.event.pull_request.base.ref }}...HEAD | tail -1)

          {
            echo 'diff<<EOF'
            echo "$DIFF"
            echo 'EOF'
            echo 'files<<EOF'
            echo "$CHANGED_FILES"
            echo 'EOF'
            echo "stats=$STATS"
          } >> "$GITHUB_OUTPUT"

      - name: Run security checks
        id: security
        continue-on-error: true
        run: |
          # npm audit if applicable
          if [ -f package.json ]; then
            npm audit --json 2>/dev/null > npm-audit.json || true
            VULNS=$(cat npm-audit.json | jq '.metadata.vulnerabilities // {}' 2>/dev/null || echo '{}')
            echo "npm_vulns=$VULNS" >> $GITHUB_OUTPUT
          fi

          # Check for secrets patterns
          SECRETS_FOUND=$(grep -rn --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" \
            -E "(api[_-]?key|secret|password|token|credential).*['\"][a-zA-Z0-9]{16,}['\"]" . 2>/dev/null | head -5 || echo "")
          {
            echo 'secrets<<EOF'
            echo "$SECRETS_FOUND"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: GPT Comprehensive Review
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF_CONTENT: ${{ steps.pr_data.outputs.diff }}
          CHANGED_FILES: ${{ steps.pr_data.outputs.files }}
          PR_STATS: ${{ steps.pr_data.outputs.stats }}
          NPM_VULNS: ${{ steps.security.outputs.npm_vulns }}
          SECRETS_FOUND: ${{ steps.security.outputs.secrets }}
        run: |
          if [ -z "$DIFF_CONTENT" ]; then
            echo "result=ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ âœ…" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Build comprehensive review prompt
          SYSTEM_PROMPT='ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚·ãƒ‹ã‚¢ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å…¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å°‚é–€å®¶ã§ã™ã€‚
          ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ä»¥ä¸‹ã®5ã¤ã®è¦³ç‚¹ã‹ã‚‰å¾¹åº•çš„ã«åˆ†æã—ã¦ãã ã•ã„ã€‚

          ## 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ (CRITICAL)

          ### OWASP Top 10 2021 ãƒã‚§ãƒƒã‚¯:
          - A01: ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®ä¸å‚™ - èªå¯ãƒã‚¤ãƒ‘ã‚¹ã€æ¨©é™æ˜‡æ ¼
          - A02: æš—å·åŒ–ã®å¤±æ•— - å¼±ã„æš—å·åŒ–ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆéœ²å‡º
          - A03: ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ - SQLã€NoSQLã€OS ã‚³ãƒãƒ³ãƒ‰ã€LDAP
          - A04: å®‰å…¨ã§ãªã„è¨­è¨ˆ - è„…å¨ãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¬ å¦‚
          - A05: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒŸã‚¹ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã€ä¸è¦æ©Ÿèƒ½
          - A06: è„†å¼±ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ - å¤ã„ä¾å­˜é–¢ä¿‚ã€æ—¢çŸ¥ã®CVE
          - A07: èªè¨¼ã®å¤±æ•— - èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
          - A08: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®å¤±æ•— - æœªç½²åãƒ‡ãƒ¼ã‚¿ã€å®‰å…¨ã§ãªã„ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
          - A09: ãƒ­ã‚°è¨˜éŒ²ã®å¤±æ•— - ç›£æŸ»ãƒ­ã‚°æ¬ å¦‚ã€ãƒ­ã‚°ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
          - A10: SSRF - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒª

          ### è¿½åŠ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯:
          - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ï¼ˆAPIã‚­ãƒ¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
          - å®‰å…¨ã§ãªã„æ­£è¦è¡¨ç¾ï¼ˆReDoSè„†å¼±æ€§ï¼‰
          - ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«è„†å¼±æ€§
          - XSSï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼‰
          - CSRFä¿è­·
          - å…¬é–‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
          - å…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã¨æ¤œè¨¼

          ## 2. ãƒã‚°ãƒ»ã‚¨ãƒ©ãƒ¼åˆ†æ

          ### ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:
          - ã‚ªãƒ•ãƒã‚¤ãƒ¯ãƒ³ã‚¨ãƒ©ãƒ¼
          - Null/undefinedå‚ç…§å‡¦ç†
          - ç«¶åˆçŠ¶æ…‹ã¨ä¸¦è¡Œæ€§ã®å•é¡Œ
          - ç„¡é™ãƒ«ãƒ¼ãƒ—ã¾ãŸã¯å†å¸°
          - èª¤ã£ãŸãƒ–ãƒ¼ãƒ«è«–ç†
          - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å‡¦ç†ï¼ˆç©ºé…åˆ—ã€nullã€å¢ƒç•Œå€¤ï¼‰

          ### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:
          - ã‚­ãƒ£ãƒƒãƒã•ã‚Œãªã„ä¾‹å¤–
          - æ¬ è½ã—ãŸtry-catchãƒ–ãƒ­ãƒƒã‚¯
          - ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå¤±æ•—ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã®catchï¼‰
          - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æƒ…å ±æ¼æ´©
          - é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ä¼æ’­

          ### å‹å®‰å…¨æ€§:
          - å‹å¼·åˆ¶ã®å•é¡Œ
          - å®‰å…¨ã§ãªã„å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³
          - æ¬ è½ã—ãŸnullãƒã‚§ãƒƒã‚¯
          - any/unknownå‹ã®ä¹±ç”¨

          ## 3. ä¿å®ˆæ€§åˆ†æ

          ### ã‚³ãƒ¼ãƒ‰è¤‡é›‘æ€§:
          - ã‚µã‚¤ã‚¯ãƒ­ãƒãƒ†ã‚£ãƒƒã‚¯è¤‡é›‘åº¦ > 10ï¼ˆé–¢æ•°ã‚’ãƒ•ãƒ©ã‚°ï¼‰
          - æ·±ããƒã‚¹ãƒˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ï¼ˆ> 3ãƒ¬ãƒ™ãƒ«ï¼‰
          - é•·ã„é–¢æ•°ï¼ˆ> 50è¡Œï¼‰
          - å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ> 500è¡Œï¼‰
          - ç¥ã‚¯ãƒ©ã‚¹/ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

          ### ã‚³ãƒ¼ãƒ‰å“è³ª:
          - DRYé•åï¼ˆé‡è¤‡ã‚³ãƒ¼ãƒ‰ï¼‰
          - SOLIDåŸå‰‡é•å
          - ä¸æ˜ç¢ºãªå‘½åè¦å‰‡
          - ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼/æ–‡å­—åˆ—
          - ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰
          - TODO/FIXME/HACKã‚³ãƒ¡ãƒ³ãƒˆ

          ### å¯èª­æ€§:
          - æ¬ è½ã¾ãŸã¯å¤ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - èª¬æ˜ãªã—ã®è¤‡é›‘ãªå¼
          - ä¸€è²«æ€§ã®ãªã„ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«
          - ç´›ã‚‰ã‚ã—ã„åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼

          ## 4. è„†å¼±æ€§è©•ä¾¡

          ### ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:
          - æ—¢çŸ¥ã®è„†å¼±ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®ã‚ã‚‹å¤ã„ä¾å­˜é–¢ä¿‚
          - ä¸è¦ãªä¾å­˜é–¢ä¿‚ï¼ˆæ”»æ’ƒå¯¾è±¡é ˜åŸŸï¼‰
          - ãƒ©ã‚¤ã‚»ãƒ³ã‚¹äº’æ›æ€§ã®å•é¡Œ

          ### ãƒ‡ãƒ¼ã‚¿ä¿è­·:
          - PII/æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®éœ²å‡º
          - ä¸ååˆ†ãªãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
          - æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–æ¬ å¦‚
          - å®‰å…¨ã§ãªã„ãƒ‡ãƒ¼ã‚¿é€ä¿¡

          ## 5. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å“è³ª

          ### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸:
          - æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã®å˜ä½“ãƒ†ã‚¹ãƒˆæ¬ å¦‚
          - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆæ¬ å¦‚
          - å£Šã‚ŒãŸã¾ãŸã¯ä¸å®‰å®šãªãƒ†ã‚¹ãƒˆ
          - ãƒ†ã‚¹ãƒˆå“è³ªï¼ˆã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ¢ãƒƒã‚­ãƒ³ã‚°ï¼‰

          ### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:
          - APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¬ å¦‚
          - å¤ã„README
          - è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆæ¬ å¦‚
          - å¤‰æ›´ãƒ­ã‚°æ›´æ–°ã®å¿…è¦æ€§

          ### æŠ€è¡“çš„è² å‚µ:
          - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã™ã¹ãå›é¿ç­–
          - éæ¨å¥¨APIä½¿ç”¨
          - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³
          - ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®æ‡¸å¿µ

          ---

          ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå¿…ãšä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ï¼‰

          ## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ
          | é‡å¤§åº¦ | å•é¡Œ | å ´æ‰€ | CWE | ä¿®æ­£æ¡ˆ |
          |--------|------|------|-----|--------|
          | CRITICAL | ... | file:line | CWE-XXX | ... |
          | HIGH | ... | ... | ... | ... |

          ## ğŸ› ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆ
          | å„ªå…ˆåº¦ | å•é¡Œ | å ´æ‰€ | å½±éŸ¿ | ä¿®æ­£æ¡ˆ |
          |--------|------|------|------|--------|
          | P0 | ... | file:line | ... | ... |

          ## ğŸ”§ ä¿å®ˆæ€§ãƒ¬ãƒãƒ¼ãƒˆ
          | ã‚«ãƒ†ã‚´ãƒª | å•é¡Œ | å ´æ‰€ | ææ¡ˆ |
          |----------|------|------|------|
          | è¤‡é›‘æ€§ | ... | ... | ... |

          ## ğŸ“¦ ä¾å­˜é–¢ä¿‚ãƒ¬ãƒãƒ¼ãƒˆ
          | ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ç¾åœ¨ | å•é¡Œ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
          |-----------|------|------|----------|

          ## ğŸ“Š ã‚µãƒãƒªãƒ¼
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢: X/10
          - ãƒã‚°ãƒªã‚¹ã‚¯: X/10
          - ä¿å®ˆæ€§: X/10
          - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: æ¨å®šX%
          - ç·åˆ: âœ… æ‰¿èª / âš ï¸ è¦ä¿®æ­£ / âŒ ãƒ–ãƒ­ãƒƒã‚¯

          ## ğŸš¨ ã™ã¹ã¦ã®CRITICALå•é¡Œï¼ˆå¿…é ˆä¿®æ­£ï¼‰
          ç™ºè¦‹ã•ã‚ŒãŸã™ã¹ã¦ã®CRITICALå•é¡Œã‚’åˆ—æŒ™ã€‚ä»¶æ•°åˆ¶é™ãªã—ã€‚

          ## âš ï¸ ã™ã¹ã¦ã®HIGHå„ªå…ˆåº¦å•é¡Œ
          ç™ºè¦‹ã•ã‚ŒãŸã™ã¹ã¦ã®HIGHå•é¡Œã‚’åˆ—æŒ™ã€‚ä»¶æ•°åˆ¶é™ãªã—ã€‚

          ## ğŸ“ ã™ã¹ã¦ã®MEDIUMå„ªå…ˆåº¦å•é¡Œ
          ç™ºè¦‹ã•ã‚ŒãŸã™ã¹ã¦ã®MEDIUMå•é¡Œã‚’åˆ—æŒ™ã€‚ä»¶æ•°åˆ¶é™ãªã—ã€‚

          ## ğŸ’¡ LOWå„ªå…ˆåº¦/ææ¡ˆ
          ç™ºè¦‹ã•ã‚ŒãŸã™ã¹ã¦ã®LOWå•é¡Œã¨æ”¹å–„ææ¡ˆã‚’åˆ—æŒ™ã€‚ä»¶æ•°åˆ¶é™ãªã—ã€‚

          é‡è¦: å„ã‚«ãƒ†ã‚´ãƒªã§ã™ã¹ã¦ã®ç™ºè¦‹ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚Top 3ãªã©ã®åˆ¶é™ã¯ç¦æ­¢ã€‚
          å•é¡ŒãŒãªã„ã‚«ãƒ†ã‚´ãƒªã¯ã€Œâœ… å•é¡Œãªã—ã€ã¨è¨˜è¼‰'

          # Build the user message with context
          USER_MESSAGE="## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
          $CHANGED_FILES

          ## å¤‰æ›´çµ±è¨ˆ
          $PR_STATS

          ## npmè„†å¼±æ€§æƒ…å ±
          $NPM_VULNS

          ## ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
          $SECRETS_FOUND

          ## ã‚³ãƒ¼ãƒ‰å·®åˆ†
          $DIFF_CONTENT"

          # Create JSON payload
          PAYLOAD=$(jq -n \
            --arg system "$SYSTEM_PROMPT" \
            --arg user "$USER_MESSAGE" \
            '{
              "model": "gpt-5.2",
              "messages": [
                {"role": "system", "content": $system},
                {"role": "user", "content": $user}
              ],
              "max_completion_tokens": 8000,
              "temperature": 0.1
            }')

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD")

          # Check for API errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown API error"')
            echo "API Error: $ERROR_MSG" >&2
            REVIEW="âš ï¸ API ã‚¨ãƒ©ãƒ¼: $ERROR_MSG"
          else
            REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"')
          fi

          {
            echo 'result<<EOF'
            echo "$REVIEW"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Post review comment
        uses: actions/github-script@v7
        env:
          REVIEW_RESULT: ${{ steps.review.outputs.result }}
          PR_STATS: ${{ steps.pr_data.outputs.stats }}
        with:
          script: |
            const review = process.env.REVIEW_RESULT || 'ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒã‚ã‚Šã¾ã›ã‚“';
            const stats = process.env.PR_STATS || '';
            const now = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            const body = [
              '## ğŸ¤– GPT-5.2 Comprehensive Code Review',
              `ğŸ“… ${now}`,
              `ğŸ“Š Changes: ${stats}`,
              '',
              review,
              '',
              '---',
              '*Powered by OpenAI GPT-5.2 | Multi-dimensional Security & Quality Analysis*'
            ].join('\n');

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('GPT-5.2 Comprehensive Code Review')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç‰¹åŒ–ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ[security]ã‚¿ã‚°ä»˜ãPRï¼‰
  security-focused-review:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false &&
      (contains(github.event.pull_request.title, '[security]') ||
       contains(github.event.pull_request.labels.*.name, 'security'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD \
            -- . ':!*.md' ':!*.json' ':!*.lock' | head -c ${{ env.MAX_DIFF_SIZE }})
          {
            echo 'content<<EOF'
            echo "$DIFF"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: GPT Security Audit
        id: security_review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF_CONTENT: ${{ steps.diff.outputs.content }}
        run: |
          SYSTEM_PROMPT='ã‚ãªãŸã¯ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ã‚¿ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã®å°‚é–€å®¶ã§ã™ã€‚
          æ”»æ’ƒè€…ã®è¦–ç‚¹ã§ã‚³ãƒ¼ãƒ‰ã‚’å¾¹åº•çš„ã«åˆ†æã—ã¦ãã ã•ã„ã€‚

          ## Phase 1: æ”»æ’ƒå¯¾è±¡é ˜åŸŸåˆ†æ
          - ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆAPIã€ãƒ•ã‚©ãƒ¼ãƒ ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰ã‚’ç‰¹å®š
          - èªè¨¼ãƒ»èªå¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
          - ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨ä¿¡é ¼å¢ƒç•Œã‚’ç‰¹å®š

          ## Phase 2: è„†å¼±æ€§ãƒãƒ³ãƒ†ã‚£ãƒ³ã‚°

          ### èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³
          - å¼±ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼
          - ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®š/ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯
          - JWTè„†å¼±æ€§ï¼ˆnoneã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€å¼±ã„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼‰
          - OAuth/OIDCè¨­å®šãƒŸã‚¹
          - Remember meæ©Ÿèƒ½ã®å•é¡Œ

          ### èªå¯
          - IDORï¼ˆå®‰å…¨ã§ãªã„ç›´æ¥ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‚ç…§ï¼‰
          - æ°´å¹³/å‚ç›´æ¨©é™æ˜‡æ ¼
          - é–¢æ•°ãƒ¬ãƒ™ãƒ«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡æ¬ å¦‚
          - ãƒ­ãƒ¼ãƒ«ãƒã‚¤ãƒ‘ã‚¹è„†å¼±æ€§

          ### ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒ
          - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå…¨ãƒãƒªã‚¢ãƒ³ãƒˆï¼‰
          - NoSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
          - ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
          - LDAPã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
          - XPathã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
          - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆSSTIï¼‰
          - ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

          ### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰
          - XSSï¼ˆæ ¼ç´å‹ã€åå°„å‹ã€DOMãƒ™ãƒ¼ã‚¹ï¼‰
          - CSRF
          - ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°
          - ã‚ªãƒ¼ãƒ—ãƒ³ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
          - PostMessageè„†å¼±æ€§

          ### ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰
          - SSRF
          - XXEï¼ˆXMLå¤–éƒ¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰
          - ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³è„†å¼±æ€§
          - ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆLFI/RFIï¼‰
          - ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«

          ### æš—å·
          - å¼±ã„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆMD5ã€SHA1ã€DESï¼‰
          - ä¸ååˆ†ãªéµé•·
          - äºˆæ¸¬å¯èƒ½ãªä¹±æ•°å€¤
          - æš—å·åŒ–æ¬ å¦‚
          - è¨¼æ˜æ›¸æ¤œè¨¼ã®å•é¡Œ

          ### ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
          - ç«¶åˆçŠ¶æ…‹
          - ä¾¡æ ¼æ“ä½œ
          - æ•°é‡æ”¹ã–ã‚“
          - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒã‚¤ãƒ‘ã‚¹
          - TOCTOUï¼ˆTime-of-check to time-of-useï¼‰

          ## Phase 3: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³
          - ã‚³ãƒ¼ãƒ‰å†…ã®APIã‚­ãƒ¼
          - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èªè¨¼æƒ…å ±
          - ç§˜å¯†éµ
          - ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
          - ç’°å¢ƒå¤‰æ•°æ¼æ´©

          ---

          ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

          # ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

          ## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼
          - ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç™ºè¦‹: Xä»¶
          - é«˜ãƒªã‚¹ã‚¯ç™ºè¦‹: Xä»¶
          - ç·åˆãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢: X/100

          ## è©³ç´°ãªç™ºè¦‹

          ### [CRITICAL] ç™ºè¦‹ã‚¿ã‚¤ãƒˆãƒ«
          - **CWE**: CWE-XXX
          - **CVSS**: X.X
          - **å ´æ‰€**: file:line
          - **èª¬æ˜**: ...
          - **PoC**: ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
          - **å½±éŸ¿**: ...
          - **ä¿®æ­£æ¡ˆ**: ...
          - **å‚è€ƒæ–‡çŒ®**: ...

          ## æ”»æ’ƒã‚·ãƒŠãƒªã‚ª
          1. ã‚·ãƒŠãƒªã‚ª: ...
             æ‰‹é †: ...
             å½±éŸ¿: ...

          ## ä¿®æ­£å„ªå…ˆåº¦
          1. [CRITICAL] å³åº§ã«ä¿®æ­£: ...
          2. [HIGH] 24æ™‚é–“ä»¥å†…ã«ä¿®æ­£: ...
          3. [MEDIUM] 1é€±é–“ä»¥å†…ã«ä¿®æ­£: ...

          ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–æ¨å¥¨äº‹é …
          - ...'

          PAYLOAD=$(jq -n \
            --arg system "$SYSTEM_PROMPT" \
            --arg diff "$DIFF_CONTENT" \
            '{
              "model": "gpt-5.2",
              "messages": [
                {"role": "system", "content": $system},
                {"role": "user", "content": $diff}
              ],
              "max_completion_tokens": 8000,
              "temperature": 0.1
            }')

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD")

          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown API error"')
            REVIEW="âš ï¸ API ã‚¨ãƒ©ãƒ¼: $ERROR_MSG"
          else
            REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"')
          fi

          {
            echo 'result<<EOF'
            echo "$REVIEW"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Post security review comment
        uses: actions/github-script@v7
        env:
          REVIEW_RESULT: ${{ steps.security_review.outputs.result }}
        with:
          script: |
            const review = process.env.REVIEW_RESULT || 'ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒã‚ã‚Šã¾ã›ã‚“';
            const now = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            const body = [
              '## ğŸ›¡ï¸ GPT-5.2 Security Audit',
              `ğŸ“… ${now}`,
              '',
              review,
              '',
              '---',
              '*Powered by OpenAI GPT-5.2 | Penetration Testing Perspective*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
